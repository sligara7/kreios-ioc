{
  "template_metadata": {
    "name": "Context Management Template",
    "version": "1.0.0",
    "description": "Standard context management section for all workflows",
    "purpose": "Prevent context drift, token exhaustion, and maintain workflow integrity",
    "created": "2025-10-24",
    "applies_to": "All workflows (00-setup through 04-testing_operations, plus feature_update)"
  },
  "context_management": {
    "rag_enhanced_mode": {
      "description": "RECOMMENDED - Retrieval-Augmented Generation for automatic context management",
      "setup_location": "S-03-A05 in Setup workflow (00-setup.json)",
      "tools": [
        "generate_rag_embeddings.py - Generate vector embeddings for knowledge bases",
        "rag_agent_wrapper.py - Wrap queries with automatic context injection",
        "retrieve_rag_context.py - Direct semantic retrieval"
      ],
      "benefits": [
        "Automatic context injection based on workflow state (no manual reads)",
        "Degradation detection and auto-correction (prevents report generation, workflow violations)",
        "Token-efficient retrieval (2000-8000 tokens vs 5000-10000 manual)",
        "Systematic enforcement of critical behavioral rules",
        "Periodic auto-refresh (every 4 operations or 12 minutes)",
        "Semantic search across all knowledge bases"
      ],
      "knowledge_bases": [
        "decision_flow_kb - Workflow instructions and critical behavioral rules",
        "workflow_steps_kb - Step-specific guidance and actions",
        "tool_reference_kb - Tool usage documentation",
        "architectural_definitions_kb - UAF 1.2 terms and schema",
        "system_context_kb - Runtime state (working_memory, progress)"
      ],
      "retrieval_strategies": {
        "on_step_start": "Automatically inject workflow instructions for current step",
        "on_degradation_detected": "Inject corrective context when issues detected",
        "on_tool_execution": "Load tool documentation when executing tools",
        "on_user_query": "Semantic search across all knowledge bases",
        "periodic_refresh": "Auto-refresh every 4 operations or 12 minutes"
      },
      "degradation_patterns_detected": [
        "report_generation_attempt - Prevents unwanted report generation",
        "workflow_violation - Detects skipping steps or ignoring workflow",
        "system_isolation_breach - Detects wrong directory or cross-system access",
        "context_confusion - Detects forgetting system name or current step"
      ],
      "usage_examples": {
        "wrap_query": "python3 {reflow_root}/tools/rag_agent_wrapper.py {system_root} wrap --query 'Start next step' --strategy on_step_start",
        "analyze_response": "python3 {reflow_root}/tools/rag_agent_wrapper.py {system_root} analyze --response response.txt",
        "validate_context": "python3 {reflow_root}/tools/rag_agent_wrapper.py {system_root} validate",
        "force_refresh": "python3 {reflow_root}/tools/rag_agent_wrapper.py {system_root} refresh"
      },
      "documentation": "{reflow_root}/docs/RAG_CONTEXT_MANAGEMENT.md",
      "fallback": "If RAG not set up, use manual context management mechanisms below"
    },
    "operations_counter": {
      "description": "Track operations to prevent context window exhaustion and drift",
      "threshold": 5,
      "note_rag": "RAG provides automatic periodic refresh - this is fallback for manual mode",
      "tracking": {
        "counter_field": "operations_since_refresh",
        "storage": "context/working_memory.json",
        "initial_value": 0,
        "increment_rule": "Increment after each operation that counts (see list below)"
      },
      "operations_that_count": [
        "Creating or modifying files (except tracking files)",
        "Running validation tools",
        "Generating artifacts (architecture, diagrams, documentation)",
        "Executing complex tool commands",
        "Making architectural decisions",
        "Implementing code or tests",
        "Running builds or deployments"
      ],
      "operations_that_dont_count": [
        "Reading tracking files (working_memory.json, step_progress_tracker.json, current_focus.md)",
        "Updating tracking files only",
        "Reading workflow files (decision_flow.json, workflow JSON files)",
        "Reading template files",
        "Running pwd or basic file system navigation",
        "Context refresh operations themselves"
      ],
      "refresh_trigger": {
        "condition": "When operations_since_refresh >= 5",
        "action": "IMMEDIATELY execute context refresh sequence (see refresh_sequence below)",
        "mandatory": true,
        "override": "Cannot be skipped or postponed"
      }
    },
    "degradation_signals": {
      "description": "Signs that context has degraded and immediate refresh is needed",
      "architecture_signals": [
        "Asking about system name when it's already stored in working_memory.json",
        "Forgetting current workflow, step, or substep",
        "Using wrong template format or file structure",
        "Working in wrong system directory (pwd doesn't match system_root)",
        "Referencing files from different system",
        "Creating artifacts in wrong locations",
        "Forgetting path configuration (reflow_root, system_root)",
        "Re-asking for information already provided or stored"
      ],
      "development_signals": [
        "Implementing code for undefined or unspecified interface",
        "Modifying API contracts without updating interface_registry.json",
        "Writing tests that reference non-existent endpoints",
        "Schema drift between implementation and data models",
        "Skipping mandatory quality gates",
        "Implementing features not in service_architecture.json",
        "Creating components not in architectural decomposition"
      ],
      "general_signals": [
        "Repetitive errors (same error 2+ times)",
        "Confusion about what to do next",
        "Asking for files that were already created",
        "Generating reports or summaries instead of doing work",
        "Inability to locate recently created files"
      ],
      "action_on_detection": "IMMEDIATELY execute context refresh sequence - do not continue with current operation",
      "detection_responsibility": "LLM agent must self-monitor for these signals"
    },
    "refresh_sequence": {
      "description": "Mandatory sequence when refresh triggered (threshold or degradation)",
      "trigger_conditions": [
        "operations_since_refresh >= 5",
        "Any degradation signal detected",
        "Manual refresh requested"
      ],
      "steps": [
        {
          "step": 1,
          "action": "PAUSE",
          "description": "Stop all operations immediately - do not continue current task"
        },
        {
          "step": 2,
          "action": "VERIFY PWD",
          "description": "Run 'pwd' command and confirm you are in correct system directory",
          "validation": "pwd output must exactly match system_root from working_memory.json",
          "if_wrong": "cd to correct directory immediately before proceeding"
        },
        {
          "step": 3,
          "action": "SAVE STATE",
          "description": "Update all tracking files with current state",
          "files_to_update": [
            "context/working_memory.json (update current_step, operations count, timestamp)",
            "context/step_progress_tracker.json (mark current progress)",
            "context/current_focus.md (update with current focus)"
          ]
        },
        {
          "step": 4,
          "action": "RELOAD DEFINITIONS",
          "description": "Re-read architectural definitions to refresh understanding",
          "file": "{reflow_root}/definitions/architectural_definitions.json",
          "focus": "Re-familiarize with UAF 1.2 schema, required sections, validation rules"
        },
        {
          "step": 5,
          "action": "RELOAD TEMPLATES",
          "description": "Re-read relevant templates for current workflow step",
          "path": "{reflow_root}/templates/",
          "selection": "Read templates relevant to current step (e.g., service_architecture_template.json)"
        },
        {
          "step": 6,
          "action": "RELOAD WORKFLOW",
          "description": "Re-read current workflow file",
          "file": "{reflow_root}/workflows/{current_workflow}.json",
          "focus": "Current step definition, actions, gates, tools, expected outputs"
        },
        {
          "step": 7,
          "action": "READ FOCUS",
          "description": "Read current focus file to understand what should be done next",
          "files": [
            "context/current_focus.md (for architecture workflows)",
            "context/dev_current_focus.md (for development workflow)"
          ],
          "purpose": "Understand immediate next action"
        },
        {
          "step": 8,
          "action": "READ PROGRESS",
          "description": "Read progress tracker to understand where we are in workflow",
          "files": [
            "context/step_progress_tracker.json (for architecture workflows)",
            "context/dev_progress_tracker.json (for development workflow)"
          ],
          "purpose": "Know current step, substep, completed actions"
        },
        {
          "step": 9,
          "action": "VERIFY ALIGNMENT",
          "description": "Verify next planned action aligns with workflow instructions",
          "checks": [
            "Planned action matches current_step from step_progress_tracker.json",
            "Planned action is defined in current workflow step",
            "Planned action uses correct tools and templates",
            "Planned action produces expected outputs for this step"
          ]
        },
        {
          "step": 10,
          "action": "CONFIRM STATE",
          "description": "Explicitly state understanding before resuming",
          "must_confirm": [
            "System name: {system_name}",
            "Current workflow: {workflow_id}",
            "Current step: {step_id} - {step_name}",
            "Next action: {specific_action_description}",
            "Expected output: {what_will_be_created}",
            "Tools to use: {tool_list}"
          ],
          "anti_pattern": "Next action must NOT be 'generate report' or 'create summary' unless explicitly called for in workflow"
        },
        {
          "step": 11,
          "action": "RESET COUNTER",
          "description": "Reset operations counter to 0",
          "field": "operations_since_refresh",
          "value": 0,
          "file": "context/working_memory.json",
          "timestamp": "Update last_refresh_timestamp to current time"
        },
        {
          "step": 12,
          "action": "RESUME",
          "description": "Resume work with refreshed context and confirmed action"
        }
      ],
      "frequency": "Every 5 operations OR when any degradation signal detected",
      "mandatory": "Cannot be skipped - workflow execution depends on context integrity"
    },
    "pre_operation_validation": {
      "description": "Checklist to run BEFORE EVERY significant operation",
      "when_to_run": "Before creating files, running tools, making decisions, implementing code",
      "critical_checks": [
        {
          "check": 1,
          "description": "VERIFY PWD",
          "command": "pwd",
          "validation": "Output must exactly match {system_root} from working_memory.json",
          "if_fails": "STOP - cd to correct directory, then run context refresh"
        },
        {
          "check": 2,
          "description": "READ FOCUS",
          "command": "Read context/current_focus.md or context/dev_current_focus.md",
          "purpose": "Understand what should be done next"
        },
        {
          "check": 3,
          "description": "READ PROGRESS",
          "command": "Read context/step_progress_tracker.json or context/dev_progress_tracker.json",
          "purpose": "Know current step and substep"
        },
        {
          "check": 4,
          "description": "VERIFY ACTION MATCH",
          "validation": "Planned action must match current_step in progress tracker"
        },
        {
          "check": 5,
          "description": "VERIFY WORKFLOW ALIGNMENT",
          "validation": "Planned action must align with current workflow step instructions"
        },
        {
          "check": 6,
          "description": "VERIFY SYSTEM NAME",
          "validation": "system_name from working_memory.json matches current system being worked on"
        },
        {
          "check": 7,
          "description": "CHECK OPERATIONS COUNTER",
          "validation": "operations_since_refresh must be <= 4",
          "if_fails": "Must run context refresh before continuing"
        },
        {
          "check": 8,
          "description": "VERIFY NO CROSS-CONTAMINATION",
          "validation": "No files from other systems will be modified"
        },
        {
          "check": 9,
          "description": "VERIFY PATH USAGE",
          "validation": "All paths use {system_root} or {reflow_root} from working_memory.json, not hardcoded paths"
        },
        {
          "check": 10,
          "description": "VERIFY NOT GENERATING SUMMARY",
          "validation": "About to do real work, not generate a report/summary (unless workflow explicitly calls for it)"
        }
      ],
      "enforcement": "LLM agent must internalize this checklist and run it mentally before each operation"
    },
    "token_pressure_mitigation": {
      "description": "Strategies to reduce token usage and prevent context window exhaustion",
      "strategies": {
        "micro_batching": {
          "rule": "Split large implementation tasks (>150 lines of code) into smaller sub-actions",
          "example": "Instead of 'implement entire API service', break into: 1) core domain model, 2) data access layer, 3) API endpoints, 4) error handling",
          "benefit": "Prevents token window overflow, allows context refresh between sub-actions"
        },
        "concurrency_limits": {
          "rule": "Never work on more than 3 services concurrently",
          "rationale": "Loading architecture for multiple services consumes significant tokens",
          "workflow": "Complete one service fully, then move to next"
        },
        "path_referencing": {
          "rule": "Reference artifact paths instead of re-inlining large specifications",
          "example": "Instead of pasting entire service_architecture.json, reference: 'See specs/machine/service_arch/auth_service/service_architecture.json section interfaces'",
          "benefit": "Saves tokens by not repeating large JSON structures"
        },
        "compression": {
          "rule": "Summarize unchanged sections, store verbose output in files",
          "example": "If validation passes, write 'Validation passed' instead of pasting entire validation output",
          "storage": "Store full outputs in context/tool_outputs/ for reference"
        },
        "exemplar_pattern": {
          "rule": "Document one complete example, then index variations",
          "example": "Fully document auth_service architecture, then for other services reference: 'Similar to auth_service but with X differences'",
          "benefit": "Prevents repetitive documentation of similar patterns"
        }
      }
    },
    "recovery_procedures": {
      "wrong_directory": {
        "detection": "pwd output doesn't match system_root from working_memory.json",
        "procedure": [
          "STOP all operations immediately",
          "cd {system_root} (use absolute path from working_memory.json)",
          "Verify pwd again",
          "Execute full context refresh sequence",
          "Resume work"
        ]
      },
      "lost_context": {
        "detection": "Cannot remember system name, current step, or what to do next",
        "procedure": [
          "STOP current thought process",
          "Read context/working_memory.json (get system_name, reflow_root, system_root)",
          "Read context/step_progress_tracker.json (get current step)",
          "Read context/current_focus.md (get immediate next action)",
          "Read current workflow file (get step definition)",
          "Execute full context refresh sequence",
          "Resume with confirmed action"
        ]
      },
      "repetitive_errors": {
        "detection": "Same error occurs 2+ times in a row",
        "procedure": [
          "STOP and analyze root cause",
          "Document error in context/process_log.md",
          "Execute context refresh",
          "Review workflow instructions for this step",
          "Review tool documentation",
          "Try alternative approach if available"
        ]
      }
    }
  },
  "usage_notes": [
    "This template should be added to ALL workflow files as a top-level section",
    "Place it after workflow_metadata and before workflow_steps",
    "LLM agents must internalize these practices and apply them automatically",
    "Context management is NOT optional - it's required for workflow integrity",
    "Operations counter must be tracked continuously in working_memory.json",
    "Refresh sequence must be executed whenever triggered - no exceptions",
    "Pre-operation validation should become automatic mental checklist"
  ]
}
