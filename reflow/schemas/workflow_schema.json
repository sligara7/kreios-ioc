{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/sligara7/reflow/schemas/workflow_schema.json",
  "title": "Reflow Workflow Schema",
  "description": "JSON schema for Reflow workflow definition files (v3.0+)",
  "type": "object",
  "required": ["workflow_metadata", "workflow_steps"],
  "additionalProperties": true,
  "properties": {
    "workflow_metadata": {
      "type": "object",
      "required": ["workflow_id", "name", "version", "description"],
      "properties": {
        "workflow_id": {
          "type": "string",
          "pattern": "^[0-9]{2}[a-z]?-[a-z_]+$|^feature_update$",
          "description": "Workflow identifier (e.g., 01-systems_engineering, 01a-approach_detection, or feature_update)",
          "examples": ["00-setup", "01-systems_engineering", "01a-approach_detection", "01b-bottom_up_integration", "01c-top_down_design", "feature_update"]
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable workflow name"
        },
        "version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "description": "Semantic version (major.minor.patch)",
          "examples": ["1.0.0", "1.1.0", "2.0.0"]
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Detailed workflow description"
        },
        "created_from": {
          "type": "string",
          "description": "Origin/migration information (optional)"
        },
        "last_updated": {
          "type": "string",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
          "description": "Last update date (YYYY-MM-DD)",
          "examples": ["2025-10-24"]
        },
        "purpose": {
          "type": "string",
          "description": "Primary purpose of this workflow"
        }
      }
    },
    "path_configuration": {
      "type": "object",
      "description": "Path configuration requirements (optional)",
      "properties": {
        "description": {"type": "string"},
        "required_paths": {"type": "object"},
        "path_best_practices": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "entry_points": {
      "type": "object",
      "description": "Workflow entry points for different scenarios (optional)",
      "patternProperties": {
        "^[a-z_]+$": {
          "type": "object",
          "required": ["id", "description", "first_step"],
          "properties": {
            "id": {"type": "string"},
            "description": {"type": "string"},
            "trigger": {"type": "string"},
            "first_step": {
              "type": "string",
              "description": "Step ID to start from (flexible format)",
              "examples": ["S-01", "SE-01", "D-01", "AV-00-decision"]
            },
            "optional_step": {"type": "string"}
          }
        }
      }
    },
    "context_management": {
      "type": "object",
      "description": "Context management configuration (optional)",
      "properties": {
        "description": {"type": "string"},
        "template_reference": {"type": "string"},
        "rag_enhanced_mode": {"type": "object"},
        "operations_counter": {"type": "object"},
        "degradation_signals_watch_for": {
          "type": "array",
          "items": {"type": "string"}
        },
        "degradation_detection_tools": {"type": "object"},
        "refresh_sequence_summary": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "workflow_steps": {
      "type": "array",
      "minItems": 1,
      "description": "Ordered sequence of workflow steps",
      "items": {
        "type": "object",
        "required": ["step_id", "name", "description", "phase"],
        "properties": {
          "step_id": {
            "type": "string",
            "pattern": "^[A-Z]{1,3}-[0-9]{2}[A-Z]?$|^[A-Z]{1,3}-[0-9]{2}-[a-z]+$|^[A-Z]+-[A-Za-z]+$",
            "description": "Unique step identifier (various formats allowed)",
            "examples": ["S-01", "SE-02", "D-01", "SE-01A", "S-04-decision", "D-Post"]
          },
          "name": {
            "type": "string",
            "minLength": 1,
            "description": "Step name"
          },
          "description": {
            "type": "string",
            "minLength": 1,
            "description": "Detailed step description"
          },
          "phase": {
            "type": "string",
            "minLength": 1,
            "description": "Workflow phase this step belongs to (e.g., architecture, development, testing, validation, etc.)"
          },
          "step_file": {
            "type": "string",
            "pattern": "^workflow_steps/.+\\.json$",
            "description": "Path to detailed step definition file",
            "examples": ["workflow_steps/setup/S-01-PathConfiguration.json"]
          },
          "rationale": {
            "type": "string",
            "description": "Why this step exists (optional)"
          },
          "actions": {
            "type": "array",
            "description": "Actions to perform in this step",
            "items": {
              "type": "object",
              "required": ["action_id", "description"],
              "properties": {
                "action_id": {
                  "type": "string",
                  "description": "Unique action identifier (flexible format)",
                  "examples": ["S-01-A01", "SE-02-A03", "D-Post-A04"]
                },
                "description": {
                  "type": "string",
                  "minLength": 1
                },
                "command_pattern": {
                  "type": "string",
                  "description": "Command template to execute"
                },
                "user_prompt": {
                  "type": "object",
                  "description": "Interactive prompt for user input"
                },
                "verification": {
                  "type": "string",
                  "description": "How to verify action completion"
                },
                "success_criteria": {
                  "oneOf": [
                    {"type": "string"},
                    {"type": "array", "items": {"type": "string"}}
                  ],
                  "description": "Criteria for success (string or array of strings)"
                },
                "store_in": {
                  "type": "string",
                  "description": "Where to store results"
                },
                "details": {
                  "type": "string",
                  "description": "Additional details"
                }
              }
            }
          },
          "tools_used": {
            "type": "array",
            "description": "Reflow tools invoked in this step",
            "items": {
              "type": "string",
              "description": "Tool name (may include descriptions or notes)",
              "examples": ["validate_architecture.py", "system_of_systems_graph_v2.py", "tool.py (optional)"]
            }
          },
          "outputs": {
            "type": "array",
            "description": "Files or artifacts created by this step",
            "items": {"type": "string"}
          },
          "gates": {
            "type": "array",
            "description": "Quality gates for this step",
            "items": {
              "type": "object",
              "required": ["gate_id", "name", "checks"],
              "properties": {
                "gate_id": {
                  "type": "string",
                  "pattern": "^G-[A-Z]+-[0-9]{2}$",
                  "description": "Unique gate identifier",
                  "examples": ["G-SE-01", "G-D-05"]
                },
                "name": {
                  "type": "string",
                  "minLength": 1
                },
                "checks": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "string",
                    "minLength": 1
                  }
                },
                "blocking": {
                  "type": "boolean",
                  "description": "Whether gate failure blocks progression"
                },
                "enforcement": {
                  "type": "object",
                  "description": "Two-tier enforcement (v1.1.0+)",
                  "properties": {
                    "tier_1_critical": {
                      "type": "array",
                      "description": "Critical checks that must pass",
                      "items": {"type": "string"}
                    },
                    "tier_2_important": {
                      "type": "array",
                      "description": "Important checks that should pass",
                      "items": {"type": "string"}
                    }
                  }
                },
                "severity": {
                  "type": "string",
                  "enum": ["critical", "warning", "info"],
                  "description": "Gate severity level"
                },
                "tools": {
                  "type": "array",
                  "description": "Tools used for gate validation",
                  "items": {"type": "string"}
                }
              }
            }
          },
          "next_step": {
            "oneOf": [
              {
                "type": "string",
                "description": "Next step ID or completion indicator",
                "examples": ["S-02", "SE-03", "S-04-decision", "completed", "complete"]
              },
              {
                "type": "object",
                "description": "Conditional next steps",
                "properties": {
                  "default": {"type": "string"},
                  "conditional": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["condition", "step"],
                      "properties": {
                        "condition": {"type": "string"},
                        "step": {"type": "string"}
                      }
                    }
                  }
                }
              }
            ]
          },
          "optional": {
            "type": "boolean",
            "description": "Whether this step is optional (default: false)"
          },
          "skip_if": {
            "type": "object",
            "description": "Conditions under which to skip this step"
          }
        },
        "additionalProperties": true
      }
    },
    "completion": {
      "type": "object",
      "description": "Workflow completion criteria (optional)",
      "properties": {
        "next_workflow": {
          "oneOf": [
            {
              "type": "string",
              "pattern": "^[0-9]{2}-[a-z_]+$|^feature_update$",
              "description": "Next workflow ID to transition to (without .json extension)"
            },
            {
              "type": "null",
              "description": "No next workflow (final workflow in chain)"
            }
          ]
        },
        "outputs_required": {
          "type": "array",
          "description": "Required outputs for completion",
          "items": {"type": "string"}
        },
        "quality_gates_passed": {
          "type": "array",
          "description": "Gates that must pass",
          "items": {"type": "string"}
        }
      }
    },
    "prerequisites": {
      "type": "object",
      "description": "Prerequisites for this workflow (optional)",
      "properties": {
        "templates_required": {
          "type": "array",
          "items": {"type": "string"}
        },
        "tools_required": {
          "type": "array",
          "items": {"type": "string"}
        },
        "previous_workflow": {
          "type": "string",
          "description": "Workflow that must complete before this one"
        }
      }
    }
  }
}
