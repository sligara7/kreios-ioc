---

- name: Create directory for xml files
  ansible.builtin.file:
    path: "{{ deploy_ioc_ioc_directory }}/xml"
    state: directory
    mode: "0775"

- name: Create directory for autogenerated bob files
  ansible.builtin.file:
    path: "{{ deploy_ioc_ioc_directory }}/bob"
    state: directory
    mode: "0775"

- name: Use arv-tool to generate xml file from camera
  ansible.builtin.shell: >-
    {{ adaravis_arv_tool }} -n "{{ ioc.environment.CAMERA_NAME }}" genicam >
    {{ deploy_ioc_ioc_directory }}/xml/{{ adaravis_camera_model_name }}.xml
  register: arv_tool_result
  changed_when: >-
    not ansible_check_mode and
    (arv_tool_result.rc == 0)
  failed_when: arv_tool_result.rc != 0

- name: Clone genicam-xml-converter tools
  ansible.builtin.git:
    repo: "{{ device_roles_adaravis_genicam_xml_converters_url }}"
    dest: "{{ deploy_ioc_ioc_directory }}/genicam-xml-converters"
    version: "{{ device_roles_adaravis_genicam_xml_converters_version }}"

- name: Initialize venv
  ansible.builtin.shell: >-
    cd {{ deploy_ioc_ioc_directory }}/genicam-xml-converters &&
    ./init-venv.sh
  args:
    creates: "{{ deploy_ioc_ioc_directory }}/genicam-xml-converters/venv"
  register: venv_result
  changed_when: >-
    not ansible_check_mode and
    venv_result.rc == 0 and
    not (lookup('ansible.builtin.stat', venv_path).exists)
  vars:
    venv_path: "{{ deploy_ioc_ioc_directory }}/genicam-xml-converters/venv"

- name: Autogenerate database files from xml
  ansible.builtin.shell: >-
    cd {{ deploy_ioc_ioc_directory }}/genicam-xml-converters &&
    source venv/bin/activate &&
    ./makeDb.py ../xml/{{ adaravis_camera_model_name }}.xml
    ../db/{{ adaravis_camera_model_name }}.template
  register: db_gen_result
  changed_when: >-
    not ansible_check_mode and
    db_gen_result.rc == 0

- name: Autogenerate bob files from xml
  ansible.builtin.shell: >-
    cd {{ deploy_ioc_ioc_directory }}/genicam-xml-converters &&
    source venv/bin/activate &&
    ./makeBob.py ../xml/{{ adaravis_camera_model_name }}.xml
    ../bob/{{ adaravis_camera_model_name }}
  register: bob_gen_result
  changed_when: >-
    not ansible_check_mode and
    bob_gen_result.rc == 0

- name: Remove genicam-xml-converter tools
  ansible.builtin.file:
    path: "{{ deploy_ioc_ioc_directory }}/genicam-xml-converters"
    state: absent
